
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© - Firebase</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 5px; }
        .firebase-status {
            position: fixed; top: 10px; left: 10px; background: #10b981;
            color: white; padding: 8px 16px; border-radius: 8px; z-index: 1000;
            font-size: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .saving-indicator {
            position: fixed; top: 10px; right: 10px; background: #3b82f6;
            color: white; padding: 8px 16px; border-radius: 8px; z-index: 1000;
            font-size: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDocs, query, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCYgffN2dA7IILMbI2i_1YfERkKWIrpHyA",
            authDomain: "ek-police.firebaseapp.com",
            projectId: "ek-police",
            storageBucket: "ek-police.firebasestorage.app",
            messagingSenderId: "300605258409",
            appId: "1:300605258409:web:f265025ffa5592f651c7b8"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.firebaseDB = db;
        window.firebaseModules = { collection, addDoc, setDoc, doc, getDocs, query, onSnapshot, deleteDoc };
        window.firebaseReady = true;
        
        console.log('âœ… Firebase Ù…ØªØµÙ„!');
    </script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icon = ({ name, className = "" }) => {
            const icons = {
                shield: "ğŸ›¡ï¸", search: "ğŸ”", plus: "â•", fileText: "ğŸ“„", users: "ğŸ‘¥",
                home: "ğŸ ", logout: "ğŸšª", userCog: "âš™ï¸", userPlus: "ğŸ‘¤â•",
                megaphone: "ğŸ“¢", cloud: "â˜ï¸", download: "â¬‡ï¸", activity: "ğŸ“Š", save: "ğŸ’¾"
            };
            return <span className={className}>{icons[name] || "â€¢"}</span>;
        };

        const PoliceSystem = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [loginError, setLoginError] = useState('');
            const [loginForm, setLoginForm] = useState({ id: '', password: '' });
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [firebaseStatus, setFirebaseStatus] = useState('ØªØ­Ù…ÙŠÙ„...');
            
            const [users, setUsers] = useState([]);
            const [criminals, setCriminals] = useState([]);
            const [reports, setReports] = useState([]);
            const [militaryPersonnel, setMilitaryPersonnel] = useState([]);
            const [activityLog, setActivityLog] = useState([]);
            
            const [searchTerm, setSearchTerm] = useState('');
            const [newCriminal, setNewCriminal] = useState({ name: '', crime: '', danger: 'Ù…ØªÙˆØ³Ø·' });
            const [newUser, setNewUser] = useState({ id: '', password: '', name: '', role: 'Ø¬Ù†Ø¯ÙŠ', rank: 'Cadet', department: '' });

            const loadFromFirebase = async () => {
                if (!window.firebaseReady) {
                    setTimeout(loadFromFirebase, 500);
                    return;
                }

                try {
                    const { collection, getDocs } = window.firebaseModules;
                    const db = window.firebaseDB;

                    const usersSnapshot = await getDocs(collection(db, "users"));
                    const usersData = usersSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                    
                    if (usersData.length === 0) {
                        const defaultUser = {
                            id: '1001', password: 'commander', name: 'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø­Ù…Ø¯',
                            role: 'Ù‚Ø§Ø¦Ø¯', rank: 'General', department: 'Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø§Ù…Ø©'
                        };
                        const { addDoc } = window.firebaseModules;
                        await addDoc(collection(db, "users"), defaultUser);
                        setUsers([defaultUser]);
                        
                        await addDoc(collection(db, "military_personnel"), {
                            name: 'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø­Ù…Ø¯', rank: 'General',
                            empId: '1001', department: 'Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø§Ù…Ø©', status: 'Ù†Ø´Ø·'
                        });
                    } else {
                        setUsers(usersData);
                    }

                    const criminalsSnapshot = await getDocs(collection(db, "criminals"));
                    setCriminals(criminalsSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() })));

                    const reportsSnapshot = await getDocs(collection(db, "reports"));
                    setReports(reportsSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() })));

                    const militarySnapshot = await getDocs(collection(db, "military_personnel"));
                    setMilitaryPersonnel(militarySnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() })));

                    const activitySnapshot = await getDocs(collection(db, "activity_logs"));
                    setActivityLog(activitySnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }))
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                        .slice(0, 50));

                    setFirebaseStatus('âœ… Ù…ØªØµÙ„');
                    setLoading(false);
                    
                } catch (error) {
                    console.error('Ø®Ø·Ø£:', error);
                    setFirebaseStatus('âŒ Ø®Ø·Ø£');
                    setLoading(false);
                }
            };

            const logActivity = async (action, details) => {
                if (!window.firebaseReady) return;
                
                const activity = {
                    action, details,
                    user: currentUser?.name || 'Ù†Ø¸Ø§Ù…',
                    userId: currentUser?.id || 'system',
                    timestamp: new Date().toISOString()
                };

                try {
                    const { addDoc, collection } = window.firebaseModules;
                    await addDoc(collection(window.firebaseDB, "activity_logs"), activity);
                    setActivityLog(prev => [activity, ...prev].slice(0, 50));
                } catch (error) {
                    console.error('Ø®Ø·Ø£:', error);
                }
            };

            useEffect(() => {
                loadFromFirebase();
            }, []);

            const hasPermission = (action) => {
                if (!currentUser) return false;
                const permissions = {
                    'Ù‚Ø§Ø¦Ø¯': ['view', 'add', 'edit', 'delete', 'manage_personnel'],
                    'Ø¶Ø§Ø¨Ø·': ['view', 'add', 'edit'],
                    'Ø¬Ù†Ø¯ÙŠ': ['view']
                };
                return permissions[currentUser.role]?.includes(action);
            };

            const handleLogin = async () => {
                const user = users.find(u => u.id === loginForm.id && u.password === loginForm.password);
                if (user) {
                    setCurrentUser(user);
                    setIsLoggedIn(true);
                    setLoginError('');
                    await logActivity('Ø¯Ø®ÙˆÙ„', `${user.name}`);
                } else {
                    setLoginError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    await logActivity('Ù…Ø­Ø§ÙˆÙ„Ø© ÙØ§Ø´Ù„Ø©', loginForm.id);
                }
            };

            const handleLogout = async () => {
                await logActivity('Ø®Ø±ÙˆØ¬', currentUser.name);
                setIsLoggedIn(false);
                setCurrentUser(null);
            };

            const addCriminal = async () => {
                if (!hasPermission('add')) return alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©');
                if (!newCriminal.name || !newCriminal.crime) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

                setSaving(true);
                try {
                    const criminal = {
                        name: newCriminal.name,
                        crime: newCriminal.crime,
                        danger: newCriminal.danger,
                        status: 'Ù…Ø·Ù„ÙˆØ¨',
                        date: new Date().toISOString().split('T')[0],
                        addedBy: currentUser.name
                    };

                    const { addDoc, collection } = window.firebaseModules;
                    const docRef = await addDoc(collection(window.firebaseDB, "criminals"), criminal);
                    
                    setCriminals([...criminals, { docId: docRef.id, ...criminal }]);
                    setNewCriminal({ name: '', crime: '', danger: 'Ù…ØªÙˆØ³Ø·' });
                    
                    await logActivity('Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ø±Ù…', criminal.name);
                    alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸!');
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø£');
                } finally {
                    setSaving(false);
                }
            };

            const deleteCriminal = async (docId, name) => {
                if (!hasPermission('delete')) return alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©');
                if (!confirm('Ù…ØªØ£ÙƒØ¯ØŸ')) return;

                setSaving(true);
                try {
                    const { deleteDoc, doc } = window.firebaseModules;
                    await deleteDoc(doc(window.firebaseDB, "criminals", docId));
                    
                    setCriminals(criminals.filter(c => c.docId !== docId));
                    await logActivity('Ø­Ø°Ù Ù…Ø¬Ø±Ù…', name);
                    alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø£');
                } finally {
                    setSaving(false);
                }
            };

            const addUser = async () => {
                if (!hasPermission('manage_personnel')) return alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©');
                if (!newUser.id || !newUser.password || !newUser.name) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                if (users.find(u => u.id === newUser.id)) return alert('Ù…ÙˆØ¬ÙˆØ¯!');

                setSaving(true);
                try {
                    const { addDoc, collection } = window.firebaseModules;
                    
                    const userDocRef = await addDoc(collection(window.firebaseDB, "users"), newUser);
                    
                    const militaryData = {
                        name: newUser.name, rank: newUser.rank,
                        empId: newUser.id, department: newUser.department, status: 'Ù†Ø´Ø·'
                    };
                    const militaryDocRef = await addDoc(collection(window.firebaseDB, "military_personnel"), militaryData);
                    
                    setUsers([...users, { docId: userDocRef.id, ...newUser }]);
                    setMilitaryPersonnel([...militaryPersonnel, { docId: militaryDocRef.id, ...militaryData }]);
                    
                    await logActivity('Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…', newUser.name);
                    setNewUser({ id: '', password: '', name: '', role: 'Ø¬Ù†Ø¯ÙŠ', rank: 'Cadet', department: '' });
                    alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸!');
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø£');
                } finally {
                    setSaving(false);
                }
            };

            const deleteUser = async (docId, userId, name) => {
                if (!hasPermission('manage_personnel')) return alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©');
                if (userId === currentUser.id) return alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ!');
                if (!confirm('Ù…ØªØ£ÙƒØ¯ØŸ')) return;

                setSaving(true);
                try {
                    const { deleteDoc, doc } = window.firebaseModules;
                    
                    await deleteDoc(doc(window.firebaseDB, "users", docId));
                    setUsers(users.filter(u => u.docId !== docId));
                    
                    const militaryToDelete = militaryPersonnel.find(m => m.empId === userId);
                    if (militaryToDelete) {
                        await deleteDoc(doc(window.firebaseDB, "military_personnel", militaryToDelete.docId));
                        setMilitaryPersonnel(militaryPersonnel.filter(m => m.empId !== userId));
                    }
                    
                    await logActivity('Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…', name);
                    alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø£');
                } finally {
                    setSaving(false);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center">
                        <div className="text-center">
                            <Icon name="cloud" className="text-8xl mb-4 animate-pulse" />
                            <h2 className="text-2xl font-bold text-white mb-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase...</h2>
                            <p className="text-blue-400">Loading from Firestore</p>
                        </div>
                    </div>
                );
            }

            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4">
                        <div className="firebase-status"><Icon name="cloud" /> {firebaseStatus}</div>
                        <div className="bg-slate-800 rounded-lg shadow-2xl p-8 w-full max-w-md border border-blue-800/50">
                            <div className="text-center mb-8">
                                <Icon name="shield" className="text-6xl mb-4" />
                                <h1 className="text-3xl font-bold text-white mb-2">Ù†Ø¸Ø§Ù… ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</h1>
                                <p className="text-green-400 text-xs">ğŸ”¥ Firebase - Ø­ÙØ¸ Ø¯Ø§Ø¦Ù…</p>
                            </div>
                            <div className="space-y-4">
                                <input type="text" value={loginForm.id}
                                    onChange={(e) => setLoginForm({...loginForm, id: e.target.value})}
                                    className="w-full px-4 py-3 bg-slate-700 rounded-lg text-white"
                                    placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ" />
                                <input type="password" value={loginForm.password}
                                    onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                                    onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                    className="w-full px-4 py-3 bg-slate-700 rounded-lg text-white"
                                    placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
                                {loginError && <div className="bg-red-900/40 text-red-400 p-3 rounded">{loginError}</div>}
                                <button onClick={handleLogin}
                                    className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-bold">
                                    Ø¯Ø®ÙˆÙ„
                                </button>
                                <div className="text-center text-gray-400 text-xs">
                                    <p>Ø§ÙØªØ±Ø§Ø¶ÙŠ: 1001 / commander</p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // ØªØ§Ø¨Ø¹ ÙÙŠ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ...
            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
                    <div className="firebase-status"><Icon name="cloud" /> {firebaseStatus}</div>
                    {saving && <div className="saving-indicator animate-pulse"><Icon name="save" /> Ø­ÙØ¸...</div>}
                    
                    <header className="bg-slate-900 text-white p-4 border-b-2 border-blue-800">
                        <div className="container mx-auto flex justify-between items-center flex-wrap gap-4">
                            <div className="flex items-center gap-3">
                                <Icon name="shield" className="text-4xl" />
                                <div>
                                    <h1 className="text-2xl font-bold">Ù†Ø¸Ø§Ù… ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</h1>
                                    <p className="text-xs text-green-400">Firebase Sync</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <button onClick={loadFromFirebase}
                                    className="bg-green-700 px-3 py-2 rounded hover:bg-green-600 text-sm">
                                    <Icon name="download" /> ØªØ­Ø¯ÙŠØ«
                                </button>
                                <div className="bg-slate-800 px-4 py-2 rounded">
                                    <p className="font-bold">{currentUser.name}</p>
                                    <p className="text-xs text-blue-400">{currentUser.rank}</p>
                                </div>
                                <button onClick={handleLogout}
                                    className="bg-red-700 px-4 py-2 rounded hover:bg-red-600">
                                    <Icon name="logout" /> Ø®Ø±ÙˆØ¬
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙŠ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ */}
                    <div className="container mx-auto p-6">
                        <div className="bg-yellow-600 text-white p-4 rounded-lg text-center">
                            <p className="font-bold">âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„ - Ø§ÙØªØ­ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<PoliceSystem />, document.getElementById('root'));
    </script>
</body>
</html>
