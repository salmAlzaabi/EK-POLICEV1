<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MDT | Comprehensive System</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@100;400;700;900&display=swap');
        :root { --primary: #0f172a; --secondary: #1e293b; --accent: #3b82f6; }
        body { font-family: 'Noto Kufi Arabic', sans-serif; background-color: #020617; color: #e2e8f0; margin: 0; }

        /* Tactical Styling */
        .tactical-panel { background: var(--secondary); border: 1px solid rgba(59, 130, 246, 0.1); border-right: 4px solid var(--accent); border-radius: 12px; }
        .nav-active { background: var(--accent) !important; color: white !important; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        
        /* Responsive Logic */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-right: 0 !important; padding: 15px !important; padding-bottom: 100px !important; }
            .mobile-nav { display: flex; position: fixed; bottom: 0; width: 100%; background: var(--primary); border-top: 1px solid rgba(255,255,255,0.05); z-index: 1000; padding-bottom: 20px; }
        }
        @media (min-width: 769px) {
            .mobile-nav { display: none; }
            .sidebar { width: 280px; position: fixed; right: 0; top: 0; height: 100vh; background: var(--primary); border-left: 1px solid rgba(255,255,255,0.05); }
            .main-content { margin-right: 280px; padding: 40px; }
        }

        input, select, textarea { background: #0f172a !important; border: 1px solid #334155 !important; color: white !important; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--accent) !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, setDoc, doc, deleteDoc, query, orderBy, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCYgffN2dA7IILMbI2i_1YfERkKWIrpHyA",
            authDomain: "ek-police.firebaseapp.com",
            projectId: "ek-police",
            storageBucket: "ek-police.firebasestorage.app",
            messagingSenderId: "300605258409",
            appId: "1:300605258409:web:f265025ffa5592f651c7b8"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.fb = { db, collection, onSnapshot, setDoc, doc, deleteDoc, query, orderBy, addDoc, updateDoc, serverTimestamp };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const RANK_HIERARCHY = [
            { id: 'General', weight: 19 }, { id: 'Lieutenant General', weight: 18 },
            { id: 'Major General', weight: 17 }, { id: 'Brigadier General', weight: 16 },
            { id: 'Colonel', weight: 15 }, { id: 'Major', weight: 14 },
            { id: 'Captain', weight: 13 }, { id: 'First Lieutenant', weight: 12 },
            { id: 'Lieutenant', weight: 11 }, { id: 'Staff Sergeant', weight: 10 },
            { id: 'First Sergeant', weight: 9 }, { id: 'Sergeant', weight: 8 },
            { id: 'Senior Officer', weight: 7 }, { id: 'Officer III', weight: 6 },
            { id: 'Officer II', weight: 5 }, { id: 'Officer I', weight: 4 },
            { id: 'Officer', weight: 3 }, { id: 'Solo Cadet', weight: 2 },
            { id: 'Cadet', weight: 1 }
        ];

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [users, setUsers] = useState([]);
            const [criminals, setCriminals] = useState([]);
            const [reports, setReports] = useState([]);
            const [loginForm, setLoginForm] = useState({ id: '', password: '' });
            const [reportForm, setReportForm] = useState({ content: '', time: '' });
            const [adminForm, setAdminForm] = useState({ id: '', name: '', rank: 'Cadet', role: 'Ø±ØªØ¨Ø© ÙØ±Ø¯', password: '' });

            useEffect(() => {
                if (!window.fb) return;
                window.fb.onSnapshot(window.fb.collection(window.fb.db, "users"), s => setUsers(s.docs.map(d=>d.data())));
                window.fb.onSnapshot(window.fb.collection(window.fb.db, "criminals"), s => setCriminals(s.docs.map(d=>({...d.data(), fbId: d.id}))));
                const q = window.fb.query(window.fb.collection(window.fb.db, "field_reports"), window.fb.orderBy("createdAt", "desc"));
                window.fb.onSnapshot(q, s => setReports(s.docs.map(d=>({...d.data(), fbId: d.id}))));
            }, []);

            const isCommand = (u) => u?.id === '1001' || u?.role === 'Ø±ØªØ¨Ø© Ù‚ÙŠØ§Ø¯ÙŠØ©';

            const sortedUsers = useMemo(() => {
                return [...users].sort((a, b) => {
                    const wA = RANK_HIERARCHY.find(r => r.id === a.rank)?.weight || 0;
                    const wB = RANK_HIERARCHY.find(r => r.id === b.rank)?.weight || 0;
                    return wB - wA;
                });
            }, [users]);

            const handleLogin = () => {
                const u = users.find(x => x.id === loginForm.id && x.password === loginForm.password);
                if (u) { setCurrentUser(u); setIsLoggedIn(true); } else alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©');
            };

            const NavItem = ({id, icon, label}) => (
                <button onClick={()=>setCurrentPage(id)} className={`flex flex-col md:flex-row items-center gap-3 p-3 md:px-6 md:py-4 w-full transition-all ${currentPage===id?'nav-active':'text-slate-400'}`}>
                    <span className="text-xl">{icon}</span>
                    <span className="text-[10px] md:text-sm font-bold">{label}</span>
                </button>
            );

            if (!isLoggedIn) return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-[#020617]">
                    <div className="w-full max-w-sm text-center">
                        <img src="Ø±Ø§Ø¨Ø·_Ø´Ø¹Ø§Ø±Ùƒ_Ù‡Ù†Ø§" className="w-48 h-48 mx-auto mb-6 object-contain" />
                        <h1 className="text-2xl font-black mb-8">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯</h1>
                        <div className="space-y-3">
                            <input type="text" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ" className="w-full p-4 rounded-xl text-center" onChange={e=>setLoginForm({...loginForm, id: e.target.value})} />
                            <input type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" className="w-full p-4 rounded-xl text-center" onChange={e=>setLoginForm({...loginForm, password: e.target.value})} />
                            <button onClick={handleLogin} className="w-full bg-blue-600 p-4 rounded-xl font-bold mt-4">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex">
                    <aside className="sidebar flex flex-col">
                        <div className="p-8 text-center border-b border-white/5">
                            <img src="Ø±Ø§Ø¨Ø·_Ø´Ø¹Ø§Ø±Ùƒ_Ù‡Ù†Ø§" className="w-24 h-24 mx-auto mb-4 object-contain" />
                            <h2 className="font-black text-xs tracking-widest uppercase text-blue-500">Ministry of Interior</h2>
                        </div>
                        <nav className="flex-grow pt-4">
                            <NavItem id="dashboard" icon="ğŸ“Š" label="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" />
                            <NavItem id="reports" icon="ğŸ“„" label="Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±" />
                            <NavItem id="schedule" icon="ğŸ“‹" label="Ø§Ù„Ù‚ÙˆØ©" />
                            <NavItem id="criminals" icon="âš–ï¸" label="Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†" />
                            {isCommand(currentUser) && <NavItem id="admin" icon="ğŸ› ï¸" label="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©" />}
                        </nav>
                        <button onClick={()=>setIsLoggedIn(false)} className="p-6 text-red-500 font-bold text-xs uppercase tracking-tighter">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                    </aside>

                    <nav className="mobile-nav">
                        <NavItem id="dashboard" icon="ğŸ“Š" label="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" />
                        <NavItem id="reports" icon="ğŸ“„" label="Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±" />
                        <NavItem id="schedule" icon="ğŸ“‹" label="Ø§Ù„Ù‚ÙˆØ©" />
                        <NavItem id="criminals" icon="âš–ï¸" label="Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†" />
                        {isCommand(currentUser) && <NavItem id="admin" icon="ğŸ› ï¸" label="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©" />}
                    </nav>

                    <main className="main-content flex-grow">
                        <header className="mb-8 p-4 md:p-0">
                            <h1 className="text-3xl font-black">
                                {currentPage==='dashboard' && 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©'}
                                {currentPage==='reports' && 'Ù…Ø±ÙƒØ² Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª'}
                                {currentPage==='schedule' && 'Ø³Ø¬Ù„ Ø§Ù„Ù‚ÙˆØ© (Ø§Ù„Ø±ØªØ¨)'}
                                {currentPage==='criminals' && 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†'}
                                {currentPage==='admin' && 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…'}
                            </h1>
                        </header>

                        {currentPage === 'dashboard' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 md:p-0">
                                <div className="tactical-panel p-10">
                                    <p className="text-xs text-gray-500 font-bold mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙØ±Ø§Ø¯</p>
                                    <h2 className="text-6xl font-black">{users.length}</h2>
                                </div>
                                <div className="tactical-panel p-10 border-r-red-500">
                                    <p className="text-xs text-gray-500 font-bold mb-2">ØªØ¹Ù…ÙŠÙ…Ø§Øª Ù†Ø´Ø·Ø©</p>
                                    <h2 className="text-6xl font-black text-red-500">{criminals.length}</h2>
                                </div>
                            </div>
                        )}

                        {currentPage === 'reports' && (
                            <div className="max-w-4xl mx-auto space-y-6">
                                <div className="tactical-panel p-6 border-r-blue-500">
                                    <h3 className="font-bold mb-4">Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± Ù…ÙŠØ¯Ø§Ù†ÙŠ</h3>
                                    <input type="text" placeholder="Ø§Ù„ÙˆÙ‚Øª" className="w-full p-4 mb-2 rounded-lg" value={reportForm.time} onChange={e=>setReportForm({...reportForm, time: e.target.value})} />
                                    <textarea placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©..." className="w-full p-4 h-32 rounded-lg" value={reportForm.content} onChange={e=>setReportForm({...reportForm, content: e.target.value})}></textarea>
                                    <button onClick={async()=>{
                                        await window.fb.addDoc(window.fb.collection(window.fb.db, "field_reports"), {
                                            ...reportForm, authorName: currentUser.name, authorId: currentUser.id, createdAt: window.fb.serverTimestamp()
                                        });
                                        setReportForm({content:'', time:''});
                                    }} className="w-full bg-blue-600 p-4 rounded-lg font-bold mt-2">Ù†Ø´Ø±</button>
                                </div>
                                {reports.map(r => (
                                    <div key={r.fbId} className="tactical-panel p-6">
                                        <div className="flex justify-between items-center mb-2 font-black text-xs text-blue-400">
                                            <span>{r.authorName} ({r.authorId})</span>
                                            <span>{r.incidentTime}</span>
                                        </div>
                                        <p className="text-sm opacity-80">{r.content}</p>
                                    </div>
                                ))}
                            </div>
                        )}

                        {currentPage === 'schedule' && (
                            <div className="tactical-panel overflow-x-auto">
                                <table className="w-full text-right">
                                    <thead className="bg-slate-900 text-[10px] text-gray-500 uppercase">
                                        <tr><th className="p-5">Ø§Ù„Ø±ØªØ¨Ø©</th><th className="p-5">Ø§Ù„Ø§Ø³Ù…</th><th className="p-5">Ø§Ù„Ø±Ù‚Ù…</th></tr>
                                    </thead>
                                    <tbody className="divide-y divide-white/5">
                                        {sortedUsers.map(u => (
                                            <tr key={u.id} className="hover:bg-white/5 transition-all">
                                                <td className="p-5 font-bold text-blue-400">{u.rank}</td>
                                                <td className="p-5 font-black">{u.name}</td>
                                                <td className="p-5 text-gray-500 font-mono text-xs">{u.id}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {currentPage === 'criminals' && (
                            <div className="max-w-2xl mx-auto space-y-4">
                                {criminals.map(c => (
                                    <div key={c.fbId} className="tactical-panel p-6 border-r-red-600 flex justify-between items-center">
                                        <div><h4 className="text-xl font-black text-red-500 uppercase">{c.name}</h4><p className="text-xs font-bold opacity-50">{c.crime}</p></div>
                                        {isCommand(currentUser) && <button onClick={async()=>await window.fb.deleteDoc(window.fb.doc(window.fb.db, "criminals", c.fbId))} className="text-red-500 text-xs">Ø­Ø°Ù</button>}
                                    </div>
                                ))}
                            </div>
                        )}

                        {currentPage === 'admin' && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div className="tactical-panel p-6 border-r-amber-500">
                                    <h3 className="font-black mb-6 uppercase text-xs text-amber-500 tracking-widest">Ø¥Ø¯Ø§Ø±Ø© Ø´Ø¤ÙˆÙ† Ø§Ù„Ø£ÙØ±Ø§Ø¯</h3>
                                    <div className="space-y-4">
                                        <input type="text" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ" className="w-full p-4 rounded-xl" value={adminForm.id} onChange={e=>setAdminForm({...adminForm, id:e.target.value})} />
                                        <input type="text" placeholder="Ø§Ù„Ø§Ø³Ù…" className="w-full p-4 rounded-xl" value={adminForm.name} onChange={e=>setAdminForm({...adminForm, name:e.target.value})} />
                                        <input type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" className="w-full p-4 rounded-xl" value={adminForm.password} onChange={e=>setAdminForm({...adminForm, password:e.target.value})} />
                                        <select className="w-full p-4 rounded-xl" value={adminForm.rank} onChange={e=>setAdminForm({...adminForm, rank:e.target.value})}>
                                            {RANK_HIERARCHY.map(r => <option key={r.id} value={r.id}>{r.id}</option>)}
                                        </select>
                                        <button onClick={async()=>{
                                            await window.fb.setDoc(window.fb.doc(window.fb.db, "users", adminForm.id), adminForm);
                                            alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                                            setAdminForm({id:'', name:'', rank:'Cadet', role:'Ø±ØªØ¨Ø© ÙØ±Ø¯', password:''});
                                        }} className="w-full bg-amber-600 p-4 rounded-xl font-black uppercase text-sm">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                                    </div>
                                </div>
                                <div className="space-y-3 overflow-y-auto max-h-[500px] pr-2">
                                    {users.map(u => (
                                        <div key={u.id} className="tactical-panel p-4 flex justify-between items-center text-xs">
                                            <div><p className="font-bold">{u.name}</p><p className="text-gray-500 uppercase">{u.rank} | {u.id}</p></div>
                                            <button onClick={async()=>await window.fb.deleteDoc(window.fb.doc(window.fb.db, "users", u.id))} className="text-red-500 px-2">Ø¥Ø¨Ø¹Ø§Ø¯</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
