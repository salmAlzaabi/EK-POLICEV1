<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDT | Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ù…Ø·ÙˆØ±</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@300;500;700;900&display=swap');
        
        body { font-family: 'Noto Kufi Arabic', sans-serif; margin: 0; overflow: hidden; background: #f0f4f8; height: 100vh; }
        #particles-js { position: absolute; width: 100%; height: 100%; background: linear-gradient(135deg, #e0e7ff 0%, #f1f5f9 100%); z-index: -1; }

        .glass-ui {
            background: rgba(255, 255, 255, 0.55);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 24px;
        }

        .nav-btn { transition: all 0.3s ease; margin: 5px 15px; border-radius: 12px; color: #64748b; font-weight: 500; }
        .nav-active { background: white !important; color: #4f46e5 !important; font-weight: 900; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        .action-btn { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; transition: 0.3s; }
        .action-btn:hover { transform: scale(1.02); box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2); }

        input, textarea { background: rgba(255,255,255,0.7) !important; border: 1px solid rgba(0,0,0,0.05) !important; border-radius: 12px !important; }
        
        /* Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± */
        .report-anim { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, setDoc, doc, deleteDoc, query, orderBy, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCYgffN2dA7IILMbI2i_1YfERkKWIrpHyA",
            authDomain: "ek-police.firebaseapp.com",
            projectId: "ek-police",
            storageBucket: "ek-police.firebasestorage.app",
            messagingSenderId: "300605258409",
            appId: "1:300605258409:web:f265025ffa5592f651c7b8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.fb = { db, collection, onSnapshot, setDoc, doc, deleteDoc, query, orderBy, addDoc, serverTimestamp, updateDoc };

        particlesJS("particles-js", {
            "particles": {
                "number": { "value": 60 }, "color": { "value": "#4f46e5" },
                "shape": { "type": "circle" }, "opacity": { "value": 0.2 },
                "size": { "value": 3 }, "line_linked": { "enable": true, "distance": 150, "color": "#4f46e5", "opacity": 0.1 }
            },
            "interactivity": { "events": { "onhover": { "enable": true, "mode": "grab" } } }
        });
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [users, setUsers] = useState([]);
            const [reports, setReports] = useState([]);
            
            // State Ù„Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            const [reportInput, setReportInput] = useState('');
            const [editingReportId, setEditingReportId] = useState(null);

            useEffect(() => {
                if (!window.fb) return;
                window.fb.onSnapshot(window.fb.collection(window.fb.db, "users"), (snap) => {
                    setUsers(snap.docs.map(d => ({ ...d.data(), fbId: d.id })));
                });
                const q = window.fb.query(window.fb.collection(window.fb.db, "reports"), window.fb.orderBy("timestamp", "desc"));
                window.fb.onSnapshot(q, (snap) => {
                    setReports(snap.docs.map(d => ({ ...d.data(), fbId: d.id })));
                });
            }, []);

            const isCommand = (u) => u?.id === '1001' || u?.role === 'Ø±ØªØ¨Ø© Ù‚ÙŠØ§Ø¯ÙŠØ©';

            const handleLogin = (id, pass) => {
                const u = users.find(x => x.id === id && x.password === pass);
                if (u) { setCurrentUser(u); setIsLoggedIn(true); } else alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            };

            const saveReport = async () => {
                if (!reportInput.trim()) return;
                if (editingReportId) {
                    // ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø±ÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
                    await window.fb.updateDoc(window.fb.doc(window.fb.db, "reports", editingReportId), {
                        content: reportInput,
                        editedAt: window.fb.serverTimestamp()
                    });
                    setEditingReportId(null);
                } else {
                    // Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ± Ø¬Ø¯ÙŠØ¯
                    await window.fb.addDoc(window.fb.collection(window.fb.db, "reports"), {
                        userName: currentUser.name,
                        userId: currentUser.id,
                        content: reportInput,
                        timestamp: window.fb.serverTimestamp()
                    });
                }
                setReportInput('');
            };

            if (!isLoggedIn) return (
                <div className="h-screen w-full flex items-center justify-center p-6">
                    <div className="glass-ui w-full max-w-md p-10 text-center shadow-2xl border-white/40">
                        <div className="w-16 h-16 bg-indigo-600 rounded-2xl mx-auto mb-6 flex items-center justify-center text-white text-3xl shadow-lg">ğŸ›¡ï¸</div>
                        <h1 className="text-2xl font-black text-slate-800 mb-8">Ù†Ø¸Ø§Ù… ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ</h1>
                        <input type="text" id="uid" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ" className="w-full mb-3 p-4" />
                        <input type="password" id="ups" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" className="w-full mb-6 p-4" />
                        <button onClick={() => handleLogin(document.getElementById('uid').value, document.getElementById('ups').value)} 
                                className="w-full action-btn py-4 rounded-xl font-black uppercase tracking-wider">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen p-4 overflow-hidden relative z-10">
                    {/* Sidebar */}
                    <aside className="glass-ui w-72 flex flex-col py-6">
                        <div className="px-8 mb-10 text-center">
                            <h2 className="text-xl font-black text-indigo-700">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†</h2>
                            <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Digital MDT System</p>
                        </div>
                        
                        <nav className="flex-grow">
                            <button onClick={()=>setCurrentPage('dashboard')} className={`flex items-center w-5/6 p-4 nav-btn ${currentPage==='dashboard'?'nav-active':''}`}>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
                            <button onClick={()=>setCurrentPage('reports')} className={`flex items-center w-5/6 p-4 nav-btn ${currentPage==='reports'?'nav-active':''}`}>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                            <button onClick={()=>setCurrentPage('users')} className={`flex items-center w-5/6 p-4 nav-btn ${currentPage==='users'?'nav-active':''}`}>ğŸ‘¥ Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</button>
                        </nav>

                        <div className="px-6">
                            <div className="p-4 bg-indigo-50/50 rounded-2xl border border-indigo-100 flex items-center gap-3">
                                <div className="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">{currentUser.name[0]}</div>
                                <div>
                                    <p className="text-xs font-black text-slate-800">{currentUser.name}</p>
                                    <p className="text-[9px] text-indigo-500 font-bold uppercase">{currentUser.rank}</p>
                                </div>
                            </div>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-grow glass-ui mr-4 p-8 overflow-y-auto">
                        <div className="flex justify-between items-center mb-10">
                            <h1 className="text-3xl font-black text-slate-800">
                                {currentPage === 'dashboard' && 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©'}
                                {currentPage === 'reports' && 'Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©'}
                                {currentPage === 'users' && 'Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙØ±Ø§Ø¯'}
                            </h1>
                            <div className="bg-white/80 px-4 py-2 rounded-full text-xs font-bold text-indigo-600 border border-indigo-100 shadow-sm">
                                Ù…Ø¨Ø§Ø´Ø± â€¢ {new Date().toLocaleTimeString('ar-SA')}
                            </div>
                        </div>

                        {currentPage === 'dashboard' && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="glass-ui p-6 bg-white/40 border-r-4 border-r-indigo-500">
                                    <p className="text-slate-500 text-xs font-bold mb-1">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p>
                                    <h4 className="text-3xl font-black text-slate-800">{reports.length}</h4>
                                </div>
                                <div className="glass-ui p-6 bg-white/40 border-r-4 border-r-emerald-500">
                                    <p className="text-slate-500 text-xs font-bold mb-1">Ø§Ù„Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠÙŠÙ†</p>
                                    <h4 className="text-3xl font-black text-slate-800">{users.length}</h4>
                                </div>
                            </div>
                        )}

                        {currentPage === 'reports' && (
                            <div className="max-w-4xl mx-auto space-y-8">
                                {/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙƒØªØ§Ø¨Ø© */}
                                <div className="glass-ui p-6 border-2 border-indigo-100 bg-white/40">
                                    <h3 className="font-black text-slate-700 mb-4 flex items-center gap-2">
                                        {editingReportId ? 'ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠ' : 'âœï¸ Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ø§Ø´Ø± Ø¬Ø¯ÙŠØ¯Ø©'}
                                    </h3>
                                    <textarea 
                                        className="w-full h-28 p-4 mb-4"
                                        placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø£Ùˆ Ø§Ù„Ø¨Ù„Ø§Øº Ù‡Ù†Ø§..."
                                        value={reportInput}
                                        onChange={(e)=>setReportInput(e.target.value)}
                                    ></textarea>
                                    <div className="flex justify-between items-center">
                                        <div className="text-[10px] text-slate-400 font-bold">âš ï¸ ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„ÙˆÙ‚Øª Ø¢Ù„ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</div>
                                        <div className="flex gap-2">
                                            {editingReportId && <button onClick={()=>{setEditingReportId(null); setReportInput('');}} className="px-4 py-2 text-slate-500 font-bold">Ø¥Ù„ØºØ§Ø¡</button>}
                                            <button onClick={saveReport} className="action-btn px-8 py-2 rounded-xl font-bold">
                                                {editingReportId ? 'ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ±' : 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±'}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± */}
                                <div className="space-y-4">
                                    {reports.map(r => (
                                        <div key={r.fbId} className="glass-ui p-6 report-anim bg-white/30 border border-white/50 group">
                                            <div className="flex justify-between items-start mb-4">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-8 h-8 bg-slate-200 rounded-lg flex items-center justify-center text-sm">ğŸ‘¤</div>
                                                    <div>
                                                        <h5 className="font-black text-slate-800 text-sm">{r.userName}</h5>
                                                        <p className="text-[9px] font-bold text-indigo-500">ÙƒÙˆØ¯: {r.userId} â€¢ {r.timestamp?.toDate().toLocaleString('ar-SA')}</p>
                                                    </div>
                                                </div>
                                                
                                                {/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Ù„Ù„Ù…Ø±Ø³Ù„ Ø£Ùˆ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©) */}
                                                {(r.userId === currentUser.id || isCommand(currentUser)) && (
                                                    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button onClick={()=>{setEditingReportId(r.fbId); setReportInput(r.content);}} className="p-2 hover:bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold">ØªØ¹Ø¯ÙŠÙ„ âœï¸</button>
                                                        <button onClick={async()=>confirm('Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ') && await window.fb.deleteDoc(window.fb.doc(window.fb.db, "reports", r.fbId))} className="p-2 hover:bg-red-50 text-red-500 rounded-lg text-xs font-bold">Ø­Ø°Ù ğŸ—‘ï¸</button>
                                                    </div>
                                                )}
                                            </div>
                                            <p className="text-slate-600 text-sm leading-relaxed border-r-2 border-slate-200 pr-4">{r.content}</p>
                                            {r.editedAt && <p className="text-[8px] text-amber-600 mt-2 font-bold font-italic">* ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ ÙÙŠ: {r.editedAt.toDate().toLocaleString('ar-SA')}</p>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {currentPage === 'users' && (
                            <div className="glass-ui overflow-hidden">
                                <table className="w-full text-right">
                                    <thead className="bg-indigo-50/50 text-[10px] font-black text-slate-400 uppercase">
                                        <tr>
                                            <th className="p-5">Ø§Ù„Ø¹Ù†ØµØ±</th>
                                            <th className="p-5">Ø§Ù„Ø±ØªØ¨Ø©</th>
                                            <th className="p-5">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {users.map(u => (
                                            <tr key={u.id} className="hover:bg-white/50 transition-colors">
                                                <td className="p-5 font-black text-slate-700">{u.name}</td>
                                                <td className="p-5 text-indigo-600 font-bold text-sm">{u.rank}</td>
                                                <td className="p-5 text-slate-400 font-mono text-xs">{u.id}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
