<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDT | Ù†Ø¸Ø§Ù… ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@100;400;700;900&display=swap');
        
        :root {
            --primary: #0f172a;
            --secondary: #1e293b;
            --accent: #3b82f6;
            --supreme: #fbbf24;
        }

        body { 
            font-family: 'Noto Kufi Arabic', sans-serif; 
            background-color: #020617;
            color: #e2e8f0;
            margin: 0;
            overflow: hidden;
        }

        .sidebar {
            width: 260px;
            background: var(--primary);
            border-left: 1px solid rgba(255,255,255,0.05);
        }

        .main-content {
            background: #0a0f1d;
            background-image: radial-gradient(#1e293b 0.5px, transparent 0.5px);
            background-size: 24px 24px;
        }

        .tactical-panel {
            background: var(--secondary);
            border: 1px solid rgba(59, 130, 246, 0.1);
            border-right: 4px solid var(--accent);
            transition: all 0.3s ease;
        }

        .nav-link {
            transition: all 0.2s;
            border-radius: 8px;
            margin: 4px 12px;
            cursor: pointer;
        }

        .nav-active {
            background: var(--accent) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        input, select, textarea {
            background: #0f172a !important;
            border: 1px solid #334155 !important;
            color: white !important;
            outline: none;
        }

        input:focus { border-color: var(--accent) !important; }

        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; display: inline-block;
            margin-left: 8px; animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.5; }
            100% { transform: scale(0.95); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, setDoc, doc, deleteDoc, query, orderBy, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCYgffN2dA7IILMbI2i_1YfERkKWIrpHyA",
            authDomain: "ek-police.firebaseapp.com",
            projectId: "ek-police",
            storageBucket: "ek-police.firebasestorage.app",
            messagingSenderId: "300605258409",
            appId: "1:300605258409:web:f265025ffa5592f651c7b8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.fb = { db, collection, onSnapshot, setDoc, doc, deleteDoc, query, orderBy, addDoc, updateDoc, serverTimestamp };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [users, setUsers] = useState([]);
            const [criminals, setCriminals] = useState([]);
            const [reports, setReports] = useState([]);
            
            // Search & Filter States
            const [searchTerm, setSearchTerm] = useState('');
            const [loginForm, setLoginForm] = useState({ id: '', password: '' });
            const [reportForm, setReportForm] = useState({ content: '', time: '', isEditing: false, docId: '' });

            useEffect(() => {
                if (!window.fb) return;
                window.fb.onSnapshot(window.fb.collection(window.fb.db, "users"), (s) => setUsers(s.docs.map(d=>d.data())));
                window.fb.onSnapshot(window.fb.collection(window.fb.db, "criminals"), (s) => setCriminals(s.docs.map(d=>({...d.data(), fbId:d.id}))));
                const q = window.fb.query(window.fb.collection(window.fb.db, "field_reports"), window.fb.orderBy("createdAt", "desc"));
                window.fb.onSnapshot(q, (s) => setReports(s.docs.map(d=>({...d.data(), fbId: d.id}))));
            }, []);

            const isCommand = (user) => user?.id === '1001' || user?.role === 'Ø±ØªØ¨Ø© Ù‚ÙŠØ§Ø¯ÙŠØ©';

            const filteredReports = useMemo(() => {
                return reports.filter(r => 
                    r.authorId.includes(searchTerm) || 
                    r.authorName.includes(searchTerm)
                );
            }, [reports, searchTerm]);

            const handleLogin = () => {
                const u = users.find(x => x.id === loginForm.id && x.password === loginForm.password);
                if (u) { setCurrentUser(u); setIsLoggedIn(true); } else alert('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            };

            const submitReport = async () => {
                if (!reportForm.content || !reportForm.time) return;
                const data = {
                    content: reportForm.content,
                    incidentTime: reportForm.time,
                    authorName: currentUser.name,
                    authorRank: currentUser.rank,
                    authorId: currentUser.id,
                    updated: reportForm.isEditing,
                    createdAt: window.fb.serverTimestamp()
                };
                if(reportForm.isEditing) await window.fb.updateDoc(window.fb.doc(window.fb.db, "field_reports", reportForm.docId), data);
                else await window.fb.addDoc(window.fb.collection(window.fb.db, "field_reports"), data);
                setReportForm({ content: '', time: '', isEditing: false, docId: '' });
            };

            if (!isLoggedIn) return (
                <div className="h-screen w-full flex items-center justify-center bg-[#020617]">
                    <div className="w-full max-w-md p-10 bg-[#0f172a] rounded-xl border border-blue-500/10 shadow-2xl">
                        <div className="text-center mb-8">
                            <div className="text-5xl mb-4">ğŸ›¡ï¸</div>
                            <h2 className="text-2xl font-black uppercase tracking-tighter text-white">MOI MDT LOGIN</h2>
                        </div>
                        <div className="space-y-4">
                            <input type="text" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ" className="w-full p-4 rounded" onChange={e=>setLoginForm({...loginForm, id:e.target.value})} />
                            <input type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" className="w-full p-4 rounded" onChange={e=>setLoginForm({...loginForm, password:e.target.value})} onKeyPress={e=>e.key==='Enter'&&handleLogin()} />
                            <button onClick={handleLogin} className="w-full bg-blue-600 hover:bg-blue-700 py-4 rounded font-bold uppercase transition-all">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen overflow-hidden text-right">
                    <aside className="sidebar flex flex-col h-full shadow-2xl z-50">
                        <div className="p-8 text-center border-b border-white/5">
                            <h2 className="text-2xl font-black">MDT</h2>
                            <p className="text-[10px] text-gray-500 font-bold uppercase tracking-[0.2em]">Interior Ministry</p>
                        </div>
                        <nav className="flex-grow mt-8">
                            <button onClick={()=>setCurrentPage('dashboard')} className={`flex items-center w-[236px] p-4 nav-link ${currentPage==='dashboard'?'nav-active':''}`}>ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</button>
                            <button onClick={()=>setCurrentPage('reports')} className={`flex items-center w-[236px] p-4 nav-link ${currentPage==='reports'?'nav-active':''}`}>ğŸ“„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©</button>
                            <button onClick={()=>setCurrentPage('criminals')} className={`flex items-center w-[236px] p-4 nav-link ${currentPage==='criminals'?'nav-active':''}`}>âš–ï¸ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†</button>
                        </nav>
                        <div className="p-6 border-t border-white/5 bg-black/20 text-center">
                            <p className="text-xs font-black text-blue-400">{currentUser.name}</p>
                            <p className="text-[9px] text-gray-500 font-mono mt-1">{currentUser.rank}</p>
                        </div>
                    </aside>

                    <main className="flex-grow main-content overflow-y-auto p-10">
                        <header className="flex justify-between items-end mb-12 border-b border-white/10 pb-8">
                            <div>
                                <h1 className="text-5xl font-black tracking-tight">
                                    {currentPage === 'reports' ? 'Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±' : 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…'}
                                </h1>
                                <p className="text-blue-500 text-sm font-bold mt-3"><span className="status-dot bg-green-500"></span> Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø§Ø³ØªØ®Ø¨Ø§Ø±Ø§Øª</p>
                            </div>
                        </header>

                        {currentPage === 'reports' && (
                            <div className="max-w-5xl mx-auto space-y-10">
                                {/* Ø§Ù„Ø¨Ø­Ø« */}
                                <div className="tactical-panel p-4 border-r-amber-500 flex gap-4 items-center">
                                    <span className="text-xl px-2">ğŸ”</span>
                                    <input 
                                        type="text" 
                                        placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..." 
                                        className="w-full bg-transparent border-none !p-2 text-lg" 
                                        value={searchTerm}
                                        onChange={e => setSearchTerm(e.target.value)}
                                    />
                                    {searchTerm && (
                                        <span className="text-[10px] bg-amber-500/20 text-amber-500 px-3 py-1 rounded font-bold">
                                            Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: {filteredReports.length}
                                        </span>
                                    )}
                                </div>

                                {/* Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± */}
                                <div className="tactical-panel p-8 border-r-blue-600 bg-[#0f172a]/80">
                                    <h3 className="text-xl font-black mb-6 flex items-center gap-3">
                                        <span className="w-2 h-6 bg-blue-600"></span>
                                        {reportForm.isEditing ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØªØ§Ø±' : 'ØªØ­Ø±ÙŠØ± Ù…Ø¨Ø§Ø´Ø± Ù…ÙŠØ¯Ø§Ù†ÙŠ'}
                                    </h3>
                                    <div className="space-y-4">
                                        <input type="text" placeholder="ÙˆÙ‚Øª ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©" className="w-full p-4 rounded text-lg" value={reportForm.time} onChange={e=>setReportForm({...reportForm, time:e.target.value})} />
                                        <textarea placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© Ø¨Ø¯Ù‚Ø©..." className="w-full h-40 p-4 rounded text-lg" value={reportForm.content} onChange={e=>setReportForm({...reportForm, content:e.target.value})}></textarea>
                                        <div className="flex gap-3">
                                            <button onClick={submitReport} className="flex-grow bg-blue-600 hover:bg-blue-700 py-4 rounded font-black text-lg shadow-xl shadow-blue-900/20">Ø­ÙØ¸ ÙˆÙ†Ø´Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                                            {reportForm.isEditing && <button onClick={()=>setReportForm({content:'', time:'', isEditing:false})} className="px-8 bg-slate-800 rounded font-bold">Ø¥Ù„ØºØ§Ø¡</button>}
                                        </div>
                                    </div>
                                </div>

                                {/* Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± */}
                                <div className="grid gap-6">
                                    {filteredReports.map(rep => (
                                        <div key={rep.fbId} className="tactical-panel p-8 bg-black/40 border-white/5">
                                            <div className="flex justify-between items-start mb-6">
                                                <div className="flex items-center gap-4">
                                                    <div className="w-12 h-12 bg-blue-600/20 rounded-lg flex items-center justify-center font-black text-blue-500 border border-blue-500/20">
                                                        {rep.authorId.slice(-2)}
                                                    </div>
                                                    <div>
                                                        <h4 className="text-xl font-black">{rep.authorName}</h4>
                                                        <p className="text-xs text-blue-400 font-bold uppercase tracking-wider">{rep.authorRank} â€¢ ID: {rep.authorId}</p>
                                                    </div>
                                                </div>
                                                <div className="text-left font-mono text-[11px] opacity-40 leading-tight">
                                                    {rep.incidentTime}<br/>
                                                    {rep.updated && <span className="text-amber-500 font-bold tracking-tighter text-[10px]">REVISED REPORT</span>}
                                                </div>
                                            </div>
                                            <p className="text-gray-300 text-lg leading-relaxed pr-6 border-r-2 border-blue-600/30">{rep.content}</p>
                                            
                                            <div className="mt-8 pt-6 border-t border-white/5 flex gap-6 justify-end">
                                                {currentUser.id === rep.authorId && (
                                                    <button onClick={()=>{setReportForm({content:rep.content, time:rep.incidentTime, isEditing:true, docId:rep.fbId}); window.scrollTo(0,0)}} className="text-xs font-black text-blue-400 hover:text-white uppercase">Edit</button>
                                                )}
                                                {(currentUser.id === rep.authorId || isCommand(currentUser)) && (
                                                    <button onClick={async()=>confirm('Ø­Ø°ÙØŸ')&&await window.fb.deleteDoc(window.fb.doc(window.fb.db, "field_reports", rep.fbId))} className="text-xs font-black text-red-500 hover:text-white uppercase">Delete</button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {filteredReports.length === 0 && <div className="text-center py-20 opacity-20 font-black text-3xl italic">NO DATA FOUND</div>}
                                </div>
                            </div>
                        )}

                        {currentPage === 'dashboard' && (
                             <div className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl">
                                <div className="tactical-panel p-10"><p className="text-gray-500 font-bold text-xs uppercase mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</p><h3 className="text-6xl font-black">{reports.length}</h3></div>
                                <div className="tactical-panel p-10 border-r-red-500"><p className="text-gray-500 font-bold text-xs uppercase mb-2">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p><h3 className="text-6xl font-black text-red-500">{criminals.length}</h3></div>
                             </div>
                        )}
                        
                        {currentPage === 'criminals' && (
                            <div className="max-w-3xl mx-auto space-y-4">
                                {criminals.map(c => (
                                    <div key={c.fbId} className="tactical-panel p-6 border-r-red-600 bg-red-600/5">
                                        <h4 className="text-2xl font-black text-red-500">{c.name}</h4>
                                        <p className="text-gray-400 font-bold text-sm mt-1 uppercase">{c.crime}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
